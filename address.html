<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <title>Inserisci Indirizzo</title>
    <link rel="icon" href="resources/favicon.ico" />
    <link rel="stylesheet" type="text/css" title="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css" title="stylesheet" href="map.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">

  </head>

  <body>
    <header>
      <a href="home.html">
      <h1>Yook!</h1>
      </a>
      <h2>Inserisci Indirizzo</h2>
    </header>


    <div class="pac-card" id="pac-card">

        <div id="title">
          Scegli luogo consegna:
        </div>

      <div id="pac-container">
        <input id="pac-input" type="text"
            placeholder="Enter a location">
      </div>

      <button id="but" onclick="geolocate()">Geo me</button>
    </div>

    <div id="accu"></div>

    <br/>

    <h3>Google Mappo</h3>
        <div id="map"></div>





                <script>
                var map;
                  function initMap() {
                    var uluru = {lat: 44.1370565, lng: 12.2381712};
                    map = new google.maps.Map(document.getElementById('map'), {
                      zoom: 19,//minimo 18 per avere il tilt
                      center: uluru,
                      streetViewControl: false, //niente omino street view
                      mapTypeId: 'hybrid', //solo ibrida o satellite per il tilt
                      tilt: 45, //45 quando possibile

                    });
                    var marker = new google.maps.Marker({
                      position: uluru,
                      map: map,
                      title: "Lugo selezionato per la consegna",
                      animation: google.maps.Animation.BOUNCE,
                      icon: './resources/flag.png'
                    });
                    marker.setVisible(false);

                    //SEZIONE AUTOCOMPLETE
                    var autocomplete = new google.maps.places.Autocomplete(document.getElementById('pac-input'));

                    autocomplete.setTypes(['address']);
                    autocomplete.setComponentRestrictions(
                      {
                        country: 'IT'
                        //postalCode: '47923'
                      });

                    //se true i suggerimenti sono esclusivamente delle restrizioni
                    autocomplete.setOptions({strictBounds: false});

                    // Bind the map's bounds (viewport) property to the autocomplete object,
                    // so that the autocomplete requests use the current map bounds for the
                    // bounds option in the request.
                    //suggerimenti in base alla mappa
                    //autocomplete.bindTo('bounds', map);

                    autocomplete.addListener('place_changed', function() {

                      marker.setVisible(true);
                      var place = autocomplete.getPlace();
                      if (!place.geometry) {
                        // User entered the name of a Place that was not suggested and
                        // pressed the Enter key, or the Place Details request failed.
                        window.alert("No details available for input: '" + place.name + "'");
                        return;
                      }

                      map.setCenter(place.geometry.location);
                      marker.setPosition(place.geometry.location);

                      var address = '';
                      if (place.address_components) {
                        address = [
                          (place.address_components[0] && place.address_components[0].short_name || ''),
                          (place.address_components[1] && place.address_components[1].short_name || ''),
                          (place.address_components[2] && place.address_components[2].short_name || '')
                        ].join(' ');
                      }

                    });


                  }

                  //FUNZIONE CHIAMATA ALLA PRESSIONE TASTO GEOLOCATION
                  function geolocate() {

                          // Try HTML5 geolocation.
                          if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(function(position) {
                              var pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                              };

                              //mostro accuratezza geolocalizzazione in un div
                              document.getElementById('accu').innerHTML = "Accuracy " + position.coords.accuracy + " m";

                              //provo reverse geocoding per avere anche l'indirizzo
                               var geocoder = new google.maps.Geocoder;
                               var latlng = {lat: position.coords.latitude, lng: position.coords.longitude};
                                 geocoder.geocode({'location': latlng}, function(results, status) {
                                   if (status === 'OK') {
                                     if (results[0]) {
                                       //setto
                                       document.getElementById('pac-input').value = results[0].formatted_address;
                                     } else {
                                       window.alert('No near address found');
                                     }
                                   } else {
                                     window.alert('near address searching failed due to: ' + status);
                                   }
                                 });

                              //creo l'infowindow
                              infoWindow = new google.maps.InfoWindow;
                              infoWindow.setPosition(pos);
                              infoWindow.setContent('Location found.');
                              infoWindow.open(map);
                              //centro la mappa sulla posizione
                              map.setCenter(pos);
                            }, function() {
                              handleLocationError(true, infoWindow, map.getCenter());
                            });
                          } else {
                            // Browser doesn't support Geolocation
                            handleLocationError(false, infoWindow, map.getCenter());
                          }
                        }

                        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                          infoWindow.setPosition(pos);
                          infoWindow.setContent(browserHasGeolocation ?
                                                'Error: The Geolocation service failed.' :
                                                'Error: Your browser doesn\'t support geolocation.');
                          infoWindow.open(map);
                        }

                </script>
        <!-- <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBinnhjlVy7a2RxTETHiw0LrCByGnrZKnQ&callback=initMap">
        </script> -->
        <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBinnhjlVy7a2RxTETHiw0LrCByGnrZKnQ&libraries=places&callback=initAutocomplete"
            async defer></script> -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBinnhjlVy7a2RxTETHiw0LrCByGnrZKnQ&libraries=places&callback=initMap"
                    async defer></script>




    <footer>
    <p>Posted by: </p>
    <p>Contact information: <a href="mailto:someone@example.com">
    someone@example.com</a>.</p>
    </footer>
  </body>
</html>
